{% extends 'finance/base.html' %}
{% load static %}

{% block title %}Income{% endblock %}

{% block extra_css %}
<style>
    /* Initial state - form hidden */
    #income-form-container {
        display: none !important;
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 5px;
    }

    .action-buttons button {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        margin-right: 5px;
    }



    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    /* Your existing table styles */
    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        padding: 12px;
        border: 1px solid #ddd;
    }

    th {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<h2>Track Your Income</h2>
<!-- Add Income Button - always visible initially -->
<button id="show-income-btn" class="btn btn-primary">Add Income</button>
<br><br>

<!-- Form Container - hidden by default -->
<div id="income-form-container">
    <form method="POST" id="income-form">
        {% csrf_token %}
        <input type="hidden" id="income-id" name="income_id" value="">

        <div class="form-group">
            <label for="id_income_type">Income Type:</label>
            {{ form.income_type }}
        </div>

        <div class="form-group">
            <label for="id_amount">Amount (₹):</label>
            {{ form.amount }}
        </div>

        <div class="form-group">
            <label for="id_date_received">Date Received:</label>
            {{ form.date_received }}
        </div>

        <div class="form-group">
            <label for="id_description">Description:</label>
            {{ form.description }}
        </div>
        <br>
        <button type="submit" class="btn btn-primary" id="submit-btn">Submit</button>
        <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button>
    </form>
</div>
<p>Total incomes: {{ incomes.count|default:"0" }}</p>
<hr>

<h3>All Income Records</h3>
<table class="table table-bordered mt-4">
    <thead class="thead-dark">
        <tr>
            <th>Income Type</th>
            <th>Amount</th>
            <th>Date Received</th>
            <th>Description</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for income in incomes %}
        <tr>
            <td>{{ income.get_income_type_display }}</td>
            <td>₹{{ income.amount }}</td>
            <td>{{ income.date_received|date:"M d, Y" }}</td>
            <td>{{ income.description|default:"-" }}</td>
            <td class="action-buttons">
                <!-- Edit button with pencil icon -->
                <button class="btn btn-outline-primary btn-sm edit-btn" title="Edit" data-id="{{ income.id }}"
                    data-type="{{ income.income_type }}" data-amount="{{ income.amount }}"
                    data-date="{{ income.date_received|date:'Y-m-d' }}" data-description="{{ income.description }}">
                    <i class="fas fa-pen"></i>
                </button>

                <!-- Delete button with trash icon -->
                <form action="{% url 'delete_income' income.id %}" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete"
                        onclick="return confirm('Are you sure you want to delete this income record?')">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
            </td>

        </tr>
        {% empty %}
        <tr>
            <td colspan="5">No income records found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const showBtn = document.getElementById('show-income-btn');
        const formContainer = document.getElementById('income-form-container');
        const cancelBtn = document.getElementById('cancel-btn');
        const incomeForm = document.getElementById('income-form');
        const incomeIdField = document.getElementById('income-id');
        const submitBtn = document.getElementById('submit-btn');

        // Show form when button is clicked
        showBtn.addEventListener('click', function () {
            formContainer.style.display = 'block';
            this.style.display = 'none';
            incomeIdField.value = ''; // Clear ID for new entry
            submitBtn.textContent = 'Submit';
        });

        // Hide form when cancel is clicked
        cancelBtn.addEventListener('click', function () {
            formContainer.style.display = 'none';
            showBtn.style.display = 'block';
            incomeForm.reset();
        });

        // Edit button functionality
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                // Populate form with existing data
                document.getElementById('id_income_type').value = this.dataset.type;
                document.getElementById('id_amount').value = this.dataset.amount;
                document.getElementById('id_date_received').value = this.dataset.date;
                document.getElementById('id_description').value = this.dataset.description;
                incomeIdField.value = this.dataset.id;

                // Update UI
                formContainer.style.display = 'block';
                showBtn.style.display = 'none';
                submitBtn.textContent = 'Update';
            });
        });

        // Ensure form is hidden on page load
        formContainer.style.display = 'none';
    });
</script>
{% endblock %}