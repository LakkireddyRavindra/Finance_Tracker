{% extends 'finance/base.html' %}
{% load static %}

{% block title %}Expenditure{% endblock %}

{% block extra_css %}
<style>
    /* Initial state - form hidden */
    #expense-form-container {
        display: none;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Form styling */
    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
    }

    .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 10px;
    }

    .btn-icon {
        background: none;
        border: none;
        padding: 5px;
        cursor: pointer;
        color: #6c757d;
    }

    .btn-icon:hover {
        color: #343a40;
    }

    .btn-icon.edit:hover {
        color: #ffc107;
    }

    .btn-icon.delete:hover {
        color: #dc3545;
    }

    /* Table styles */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    th,
    td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    tr:hover {
        background-color: #f5f5f5;
    }
</style>
{% endblock %}

{% block content %}
<h2>Track Your Expenses</h2>

<!-- Add Expense Button -->
<button id="show-expense-btn" class="btn btn-primary mb-3">Add Expense</button>

<!-- Form Container - hidden by default -->
<div id="expense-form-container">
    <form method="POST" id="expense-form">
        {% csrf_token %}
        <input type="hidden" id="expense-id" name="expense_id" value="">

        <div class="form-group">
            <label for="id_expense_type">Expense Type:</label>
            {{ form.expense_type }}
        </div>

        <div class="form-group">
            <label for="id_amount">Amount (₹):</label>
            {{ form.amount }}
        </div>
        <div class="form-group">
            <label for="id_date_incurred">Date used:</label>
            {{ form.date_incurred }}
        </div>
        <div class="form-group">
            <label for="id_description">Description:</label>
            {{ form.description }}
        </div>
        <br>

        <button type="submit" class="btn btn-primary" id="submit-btn">Submit</button>
        <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button>
    </form>
</div>

<p>Total expenses: {{ expenses.count|default:"0" }}</p>
<hr>

<h3>All Expense Records</h3>
<table class="table">
    <thead>
        <tr>
            <th>Expense Type</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Description</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for expense in expenses %}
        <tr>
            <td>{{ expense.get_expense_type_display }}</td>
            <td>₹{{ expense.amount }}</td>
            <td>{{ expense.date_incurred|date:"M d, Y" }}</td>
            <td>{{ expense.description|default:"-" }}</td>
            <td class="action-buttons">
                <button class="btn-icon edit-btn" data-id="{{ expense.id }}" data-type="{{ expense.expense_type }}"
                    data-amount="{{ expense.amount }}" data-date="{{ expense.date_incurred|date:'Y-m-d' }}"
                    data-description="{{ expense.description }}">
                    <i class="fas fa-pen"></i>
                </button>
                <form action="{% url 'delete_expense' expense.id %}" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn-icon delete"
                        onclick="return confirm('Are you sure you want to delete this expense record?')">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5">No expense records found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const showBtn = document.getElementById('show-expense-btn');
        const formContainer = document.getElementById('expense-form-container');
        const cancelBtn = document.getElementById('cancel-btn');
        const expenseForm = document.getElementById('expense-form');
        const expenseIdField = document.getElementById('expense-id');
        const submitBtn = document.getElementById('submit-btn');

        // Show form when button is clicked
        showBtn.addEventListener('click', function () {
            formContainer.style.display = 'block';
            this.style.display = 'none';
            expenseIdField.value = ''; // Clear ID for new entry
            expenseForm.reset();
            submitBtn.textContent = 'Submit';
        });

        // Hide form when cancel is clicked
        cancelBtn.addEventListener('click', function () {
            formContainer.style.display = 'none';
            showBtn.style.display = 'block';
            expenseForm.reset();
        });

        // Edit button functionality
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                // Populate form with existing data
                document.getElementById('id_expense_type').value = this.dataset.type;
                document.getElementById('id_amount').value = this.dataset.amount;
                document.getElementById('id_date_incurred').value = this.dataset.date;
                document.getElementById('id_description').value = this.dataset.description;
                expenseIdField.value = this.dataset.id;

                // Update UI
                formContainer.style.display = 'block';
                showBtn.style.display = 'none';
                submitBtn.textContent = 'Update';
            });
        });

        // Ensure form is hidden on page load
        formContainer.style.display = 'none';
    });
</script>
{% endblock %}